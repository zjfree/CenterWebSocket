<!DOCTYPE html>
<html>
<head>
    <title>websocket_Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <style>
        body, html {line-height:1.5;}
		#divInfo pre{
			font-family: 'Courier New', Courier, monospace;
		}
		#tbUserList {
			float:left;
			margin-right:10px;
			border-collapse: collapse;
			border: solid 2px #666666;
			font-size:12px;
		}
		#tbUserList th {
			border: solid 1px #666666;
			padding: 5px;
			background-color: #dedede;
			text-align: center;
		}
		#tbUserList td {
			border: solid 1px #666666;
			padding: 5px;
			background-color: #ffffff;
			text-align:center;
		}
    </style>
	<script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>
<h3 style="margin:10px 0;">webSocket</h3>
<table id="tbUserList">
	<thead>
		<tr>
			<th>UID</th>
			<th>类型</th>
			<th>名称</th>
		</tr>
	</thead>
	<tbody></tbody>
</table>

<div style="float:left;">
	<div>
		<button onclick="send('_server', 'get_user_list', {type:prompt('用户类型:')});">用户列表</button>
		<button onclick="send('_server', 'get_user_count', {type:prompt('用户类型:')});">用户数</button>
		<button onclick="send('_server', 'get_conn_list');">所有连接</button>
		<button onclick="send('_server', 'heart');">心跳</button>
		<button onclick="send('_server', 'get_current_user');">当前用户</button>
		<button onclick="send('_server', 'set_config', {a:'hello01'});">设置配置</button>
		<button onclick="send('_server', 'get_config', {key:'a'});">获取配置</button>
		<button onclick="send('_server', 'get_user', {uid:prompt('UID:')});">获取用户</button>
		<button onclick="send('_server', 'sub_user', {uid:prompt('UID:')});">订阅</button>
		<button onclick="send('_server', 'sub_user_del', {uid:prompt('UID:')});">取消订阅</button>
		&emsp;
		<button onclick="$('#divInfo').html('');">清空</button>
	</div>
	<div style="margin:5px 0;">
	<input id="txtTo" type="text" value="_server" />:<input id="txtMsg" type="text" value="get_user_list" />
	<input type="button" value="发送" onclick="send($('#txtTo').val(), $('#txtMsg').val());" />
	</div>
	<div id="divInfo" style="font-size:12px;">
	</div>
</div>
<script>

var ws = null;
var con = 'ws://127.0.0.1:9900';
var isConnect = false;
var uid = 'web_' + Math.random().toString(36).substr(2).toUpperCase();

function connect()
{
    try
    {
	   ws = new WebSocket(con);
       ws.connect = con;
    }
    catch(ex)
    {
		showError('连接失败：' + JSON.stringify(ex));
        return;
    }

	closeTimeout = window.setTimeout(function(){
		ws.close();
	}, 3000);

	ws.onopen = function() {
        window.clearTimeout(closeTimeout);
		isConnect = true;
		showInfo('连接成功');
		send('_server', 'register', {
			uid:uid,
		});
		
		// 心跳
		window.setInterval(function(){
			send('_server', 'heart');
		}, 60000);
	};
	
	ws.onmessage = function(e) {
		let data = JSON.parse(e.data);
		showInfo('RECEIVE:<pre>' + JSON.stringify(data, null, '    ') + '</pre>', 'green');

		if (data.uid == '_server')
		{
			if (data.cmd == 'get_user_list')
			{
				$('#tbUserList tbody').html('');
				for (let k in data.data)
				{
					let user = data.data[k];
					let html = '<tr id="tr_' + user.uid + '" data-uid="' + user.uid + '">';
					html += '<td>' + user.uid + '</td>';
					html += '<td>' + user.type + '</td>';
					html += '<td>' + user.name + '</td>';
					html += '</tr>';
					$('#tbUserList tbody').append(html);
				}
			}
			else if (data.cmd == 'register_success')
			{
				send('_server', 'sub_user', {uid:'_server'});
				send('_server', 'get_user_list');
			}
			else if (data.cmd == 'user_login')
			{
				let user = data.data;
				let html = '<tr id="tr_' + user.uid + '" data-uid="' + user.uid + '">';
				html += '<td>' + user.uid + '</td>';
				html += '<td>' + user.type + '</td>';
				html += '<td>' + user.name + '</td>';
				html += '</tr>';
				$('#tbUserList tbody').append(html);
			}
			else if (data.cmd == 'user_logout')
			{
				$('#tr_' + data.data).remove();
			}
		}
	};
	
	ws.onerror = function() {
		var str = JSON.stringify(arguments);
		showError('错误：' + str);
	};
	
	ws.onclose = function() {
        window.clearTimeout(closeTimeout);
		isConnect = false;
		window.setTimeout(function(){
			connect();
		}, 1000);
		showInfo('连接关闭');
	};
}

function showInfo(str, color)
{
	if (color)
	{
		$('#divInfo').prepend('<div style="color:' + color + ';">' + str + '</div>');
	}
	else
	{
		$('#divInfo').prepend('<div>' + str + '</div>');
	}
}
function showError(str)
{
	$('#divInfo').prepend('<div style="color:red;">' + str + '</div>');
}

function send(to, cmd, data)
{
	let arr = {
		to:to,
		cmd:cmd,
		data:data,
	};

	showInfo('SEND: ' + to + ',' + cmd + ',' + JSON.stringify(data), 'blue');

	if (isConnect)
	{
		ws.send(JSON.stringify(arr));
	}
}

$(function(){
	$('h3').append(' <small>' + uid + '</small>')
	connect();
});

</script>
</body>
</html>